<!DOCTYPE html>
<html>
<head>
  <title>TodoList</title>
  <style>
    /* CSS样式 */
    .todo-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .todo-item .actions {
      display: flex;
      gap: 5px;
    }
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgb(88, 90, 90);
      padding: 20px;
      border-radius: 30px;
      box-shadow: 0 10px 8px rgba(26, 24, 35, 0.4);
      width: 40%;
      /* height: fit-content; */
    }
    .notification {
      position: fixed;
      top: 8%;
      left: 50%;
      transform: translate(-50%, -60%);
      background-color: #70b09c;
      padding: 10px 20px;
      border-radius: 30px;
      box-shadow: 0 10px 8px rgba(26, 24, 35, 0.4);
      visibility: hidden;
    }

  </style>
</head>
<body>

  <div id="user-info">
    <!-- 欢迎XXX -->
  </div>
  <button id="add-item-btn" onclick="func_visibleItemModal(1)">添加事项</button>
  <button onclick="">修改昵称</button>

  <!-- 修改或添加事项弹窗:点击按钮则显示此div -->
  <div id="edit-item-modal" class="modal" style="visibility: hidden;">
    <input type="text" id="edit-item-content" style="margin-left: 15%; width: 50%;">
    <button id="edit-item-submit" style="width: 10%;" onclick="func_submitItem()">提交</button>
    <button onclick="func_visibleItemModal(0)" style="width: 10%;">取消</button>
  </div>

  <div id="todo-list">
    <!-- 待办事项列表 -->
  </div>

  <div id="notification" class="notification">4621356156461365461</div>

  <!-- JavaScript代码 --------------------------------------------------------------------------->
  <script>
    // 获取DOM元素
    const userInfoElement = document.getElementById('user-info');
    const addItemBtn = document.getElementById('add-item-btn');//添加事项按钮
    const todoListElement = document.getElementById('todo-list');
    const addItemModal = document.getElementById('add-item-modal');
    const addItemSubmitBtn = document.getElementById('add-item-submit');
    const editItemModal = document.getElementById('edit-item-modal');//浮动编辑窗口
    const editItemContentInput = document.getElementById('edit-item-content');
    const editItemSubmitBtn = document.getElementById('edit-item-submit');//提交按钮

    // 显示用户信息和待办事项列表
    const userid = localStorage.getItem('userid');
    const nickname = localStorage.getItem('nickname');
    const welcomeInformation = "欢迎用户，"+nickname;
    userInfoElement.textContent = welcomeInformation;
    func_getItems();

    //函数：发送请求获取事项数据
    function func_getItems(){
      const formData = new FormData();
      formData.append('userid', localStorage.getItem('userid'));
      fetch("/userpro/getitems", {
          method:'POST',
          body:formData,
      }).then(response =>{
          //此处获取返回的事项数据，可以进行渲染renderTodoList()
          response.json().then(data =>{
              // console.log(data.items);
              renderTodoList(data.items);
          })
      })
    }

    // 渲染待办事项列表的函数
    function renderTodoList(items) {
      todoListElement.innerHTML = '';
      items.forEach(item => {
        // 创建待办事项元素
        const todoItemElement = document.createElement('div');
        todoItemElement.classList.add('todo-item');
        // 设置待办事项样式属性
        todoItemElement.style.backgroundColor = 'lightblue';
        todoItemElement.style.border = '2px solid gray';
        todoItemElement.style.height = 'auto';
        todoItemElement.style.minHeight  = '45px'
        // 暂时保存该事项对应的唯一Id!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        const itemId = item.Id;
        // 创建任务内容元素
        const contentElement = document.createElement('div');
        contentElement.textContent = item.Content;
        contentElement.style.width = '50%'
        // 创建创建时间元素
        const createdElement = document.createElement('div');
        //修改优化时间类型  2023-10-05T16:09:02.427+08:00  =>  2023-10-05 16:09
        createdElement.textContent = "创建时间：" + item.CreateTime.slice(0, 16);
        // 创建完成状态元素
        const completedElement = document.createElement('div');
        completedElement.textContent = item.State ? '已完成' : '未完成';
        todoItemElement.style.backgroundColor = item.State? 'white':'lightblue'

        // 创建操作按钮容器元素
        const actionsElement = document.createElement('div');
        actionsElement.classList.add('actions');
        // 创建修改按钮
        const editButton = document.createElement('button');
        editButton.textContent = '修改';
        editButton.addEventListener('click', () => openEditModal(item));
        // 创建删除按钮
        const deleteButton = document.createElement('button');
        deleteButton.textContent = '删除';
        // deleteButton.addEventListener('click', () => deleteItem(item));
        // 创建完成按钮
        const completeButton = document.createElement('button');
        completeButton.textContent = '完成';
        // completeButton.addEventListener('click', () => completeItem(item));
        // 将修改、删除和完成按钮添加到操作按钮容器元素中
        actionsElement.appendChild(editButton);
        actionsElement.appendChild(deleteButton);
        actionsElement.appendChild(completeButton);
        // 将任务内容、创建时间、完成状态和操作按钮容器添加到待办事项元素中
        todoItemElement.appendChild(contentElement);
        todoItemElement.appendChild(createdElement);
        todoItemElement.appendChild(completedElement);
        todoItemElement.appendChild(actionsElement);
        // 将待办事项元素添加到待办事项列表中
        todoListElement.appendChild(todoItemElement);
      });
    }

    //按钮函数编写===================================================================================
    // 打开/关闭,添加/修改事项弹窗
    function func_visibleItemModal(tag){
      if(tag) editItemModal.style.visibility = "visible";
      else    editItemModal.style.visibility = "hidden";
    }

    // 函数：提交添加事项
    function func_submitItem(){
      console.log(editItemContentInput.value);
      const formData = new FormData();
      formData.append('userid', localStorage.getItem('userid'));
      formData.append('content', editItemContentInput.value);
      fetch("/userpro/additem", {
        method:'POST',
        body:formData,
      }).then(response =>{
        //添加事项
        if(response.status===200){
          console.log('添加成功');
          func_visibleItemModal(0);//关闭浮窗
          showNotification("添加成功", 2000);
          func_getItems();
        }else{
          alert("添加失败");
        }
      })
    }



    // 打开修改事项弹窗
    function openEditModal(item) {
      editItemContentInput.value = item.content;
      editItemModal.style.display = 'block';
      // 保存当前修改的事项数据...
    }



    // 删除事项
    function deleteItem(item) {
      // 发送到后端删除数据的逻辑...

      // 刷新列表
      renderTodoList();
    }

    // 完成事项
    function completeItem(item) {
      // 发送到后端更新数据的逻辑...

      // 刷新列表
      renderTodoList();
    }

    // 函数:产生一个临时的提示信息
    function showNotification(message, duration) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.style.visibility = 'visible';

      setTimeout(() => {
        notification.style.visibility = 'hidden';
      }, duration);
    }
  </script>
</body>
</html>
